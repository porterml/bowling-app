{% extends "base.html" %} {% block title %}Add New Game - Bowling Analytics{%
endblock %} {% block content %}
<div class="row">
	<div class="col-lg-8 mx-auto">
		<div class="card">
			<div class="card-header">
				<h3 class="card-title mb-0">
					<i class="fas fa-plus-circle me-2"></i>Add New Bowling Game
				</h3>
			</div>
			<div class="card-body">
				<form method="POST" id="gameForm">
					{{ form.hidden_tag() }}

					<div class="row mb-4">
						<div class="col-md-6">
							{{ form.date.label(class="form-label") }} {{
							form.date(class="form-control") }} {% if form.date.errors %}
							<div class="text-danger">
								{% for error in form.date.errors %}
								<small>{{ error }}</small>
								{% endfor %}
							</div>
							{% endif %}
						</div>
						<div class="col-md-6">
							<label class="form-label">Total Score</label>
							<div class="form-control-plaintext fw-bold fs-4" id="totalScore">
								0
							</div>
						</div>
					</div>

					<div class="mb-4">
						{{ form.game_notes.label(class="form-label") }} {{
						form.game_notes(class="form-control") }}
					</div>

					<h5 class="mb-3">Frame Scores</h5>
					<div class="row g-3">
						{% for frame_form in form.frames %}
						<div class="col-lg-6 col-xl-4">
							<div class="card frame-card" data-frame="{{ loop.index }}">
								<div class="card-body">
									<h6 class="card-title text-center mb-3">
										Frame {{ loop.index }}
									</h6>

									<div class="row mb-3">
										<div class="col-4">
											{{ frame_form.roll1.label(class="form-label") }} {{
											frame_form.roll1(class="form-control roll-input") }} {% if
											frame_form.roll1.errors %}
											<div class="text-danger">
												{% for error in frame_form.roll1.errors %}
												<small>{{ error }}</small>
												{% endfor %}
											</div>
											{% endif %}
										</div>
										<div class="col-4">
											{{ frame_form.roll2.label(class="form-label") }} {{
											frame_form.roll2(class="form-control roll-input") }} {% if
											frame_form.roll2.errors %}
											<div class="text-danger">
												{% for error in frame_form.roll2.errors %}
												<small>{{ error }}</small>
												{% endfor %}
											</div>
											{% endif %}
										</div>
										<div class="col-4">
											{{ frame_form.roll3.label(class="form-label") }} {{
											frame_form.roll3(class="form-control roll-input") }} {% if
											frame_form.roll3.errors %}
											<div class="text-danger">
												{% for error in frame_form.roll3.errors %}
												<small>{{ error }}</small>
												{% endfor %}
											</div>
											{% endif %}
										</div>
									</div>

									<div class="mb-3">
										<div class="form-check form-check-inline">
											{{ frame_form.is_strike(class="form-check-input
											strike-checkbox") }} {{
											frame_form.is_strike.label(class="form-check-label
											text-warning") }}
										</div>
										<div class="form-check form-check-inline">
											{{ frame_form.is_spare(class="form-check-input
											spare-checkbox") }} {{
											frame_form.is_spare.label(class="form-check-label
											text-secondary") }}
										</div>
										<div class="form-check form-check-inline">
											{{ frame_form.is_split(class="form-check-input
											split-checkbox") }} {{
											frame_form.is_split.label(class="form-check-label
											text-danger") }}
										</div>
									</div>

									<div class="mb-2">
										{{ frame_form.notes(class="form-control form-control-sm") }}
									</div>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>

					<div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
						<a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2"
							>Cancel</a
						>
						{{ form.submit(class="btn btn-primary") }}
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block scripts %}
<script>
	document.addEventListener("DOMContentLoaded", function () {
		const rollInputs = document.querySelectorAll(".roll-input");
		const strikeCheckboxes = document.querySelectorAll(".strike-checkbox");
		const spareCheckboxes = document.querySelectorAll(".spare-checkbox");
		const totalScoreElement = document.getElementById("totalScore");

		function calculateBowlingScore() {
			const frames = [];

			// Collect frame data
			for (let i = 0; i < 10; i++) {
				const frameCard = document.querySelector(`[data-frame="${i + 1}"]`);
				const roll1Input = frameCard.querySelector('input[name$="roll1"]');
				const roll2Input = frameCard.querySelector('input[name$="roll2"]');
				const roll3Input = frameCard.querySelector('input[name$="roll3"]');
				const strikeCheckbox = frameCard.querySelector(".strike-checkbox");
				const spareCheckbox = frameCard.querySelector(".spare-checkbox");

				const roll1 = parseInt(roll1Input.value) || 0;
				const roll2 = parseInt(roll2Input.value) || 0;
				const roll3 = parseInt(roll3Input.value) || 0;
				const isStrike = strikeCheckbox.checked;
				const isSpare = spareCheckbox.checked;

				frames.push({
					roll1,
					roll2,
					roll3,
					isStrike,
					isSpare,
					frameNumber: i + 1,
				});
			}

			// Calculate score using bowling rules
			let totalScore = 0;
			const frameScores = [];

			for (let i = 0; i < frames.length; i++) {
				const frame = frames[i];
				let frameScore = 0;

				if (frame.isStrike) {
					frameScore = 10;
					// Add next 2 rolls
					if (i < frames.length - 1) {
						const nextFrame = frames[i + 1];
						if (nextFrame.isStrike) {
							frameScore += 10;
							if (i + 1 < frames.length - 1) {
								frameScore += frames[i + 2].roll1;
							} else {
								frameScore += nextFrame.roll2;
							}
						} else {
							frameScore += nextFrame.roll1 + nextFrame.roll2;
						}
					} else {
						frameScore += frame.roll2 + frame.roll3;
					}
				} else if (frame.isSpare) {
					frameScore = 10;
					if (i < frames.length - 1) {
						frameScore += frames[i + 1].roll1;
					} else {
						frameScore += frame.roll3;
					}
				} else {
					frameScore = frame.roll1 + frame.roll2;
				}

				totalScore += frameScore;
				frameScores.push(frameScore);
			}

			totalScoreElement.textContent = totalScore;
			return totalScore;
		}

		function handleStrikeCheckbox(checkbox) {
			if (checkbox.checked) {
				const frameCard = checkbox.closest(".frame-card");
				const roll1Input = frameCard.querySelector('input[name$="roll1"]');
				const roll2Input = frameCard.querySelector('input[name$="roll2"]');
				const spareCheckbox = frameCard.querySelector(".spare-checkbox");

				roll1Input.value = 10;
				roll2Input.value = 0;
				spareCheckbox.checked = false;
			}
			calculateBowlingScore();
		}

		function handleSpareCheckbox(checkbox) {
			if (checkbox.checked) {
				const frameCard = checkbox.closest(".frame-card");
				const strikeCheckbox = frameCard.querySelector(".strike-checkbox");
				strikeCheckbox.checked = false;
			}
			calculateBowlingScore();
		}

		// Add event listeners
		rollInputs.forEach((input) => {
			input.addEventListener("input", calculateBowlingScore);
		});

		strikeCheckboxes.forEach((checkbox) => {
			checkbox.addEventListener("change", () => handleStrikeCheckbox(checkbox));
		});

		spareCheckboxes.forEach((checkbox) => {
			checkbox.addEventListener("change", () => handleSpareCheckbox(checkbox));
		});

		// Initial calculation
		calculateBowlingScore();
	});
</script>
{% endblock %}
